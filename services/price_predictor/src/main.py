import pandas as pd
from feature_engineering import FeatureEngineer
from sklearn.metrics import mean_absolute_error

from tools.logging_config import logger  # isort: skip
from tools.ohlc_data_reader import OhlcDataReader  # isort: skip
from tools.settings import SupportedCoins  # isort: skip

from models.baseline_models import MovingAverageBaseline  # isort: skip
from models.baseline_models import TrainMeanPctChangeBaseline  # isort: skip

FEATURE_ENGINEER_CONFIG = "services/price_predictor/src/configs/config.yaml"


def main(
    feature_view_name: str,
    feature_view_version: int,
    product_id: str,
    last_n_days_to_fetch_from_store: int,
    last_n_days_to_test_model: int,
    prediction_window_tick: int,
):
    """Run main pipeline to generate price predictions.

    The model follows the following steps:
    1. Fetch OHLC data from the feature store.
    2. Create the target variable.
    3. Train the model.
    4. Generate predictions with baseline model
    5. Compare model predictions vs baseline model predictions.


    Args:
    ----
    feature_view_name: The name of the feature view.
    feature_view_version: The version of the feature view.
    product_id: The product_id to read data for.
    last_n_days_to_fetch_from_store: The number of days to read data from.
    last_n_days_to_test_model: The number of days to test the model on.
    prediction_window_tick: The prediction window tick into the future.

    """
    # Step 1 - Fetch OHLC data
    ohlc_data_reader = OhlcDataReader(
        feature_view_name=feature_view_name,
        feature_view_version=feature_view_version,
    )
    ohlc_data = ohlc_data_reader.read_from_offline_store(
        product_id=product_id,
        last_n_days=last_n_days_to_fetch_from_store,
    )

    logger.info("Splitting data into train and test sets.")
    train_df, test_df = temporal_train_test_split(
        ohlc_data, last_n_days_to_test_model=last_n_days_to_test_model
    )

    logger.info("Creating target variable for trainset.")
    train_df = create_target_variable(train_df, prediction_window_tick)
    logger.info("Creating target variable for testset.")
    test_df = create_target_variable(test_df, prediction_window_tick)
    logger.info(
        "--------Train / Test split ----------- \n"
        f"Train: {train_df["product_id"].count()}\n"
        f"Test: {test_df["product_id"].count()}\n"
    )

    # Split into features and target for each set
    X_train, _ = train_df.drop("target", axis=1), train_df["target"]
    X_test, y_test = test_df.drop("target", axis=1), test_df["target"]

    # Add Features based on some feature engineering
    logger.info("Feature engineering pipeline.")
    feature_engineer_train = FeatureEngineer(X_train, FEATURE_ENGINEER_CONFIG)
    X_train = feature_engineer_train.add_features()

    logger.info("Generating predictions with moving average baseline model.")
    ma = MovingAverageBaseline(
        window_size=10, prediction_horizon=prediction_window_tick
    )
    baseline_predictions = ma.predict(X_test, X_train)
    mae_pct_change = mean_absolute_error(y_test, baseline_predictions)
    logger.info(f"Mean Absolute Error: {mae_pct_change}")

    logger.info("Generating predictions with simple baseline model.")
    simple_baseline = TrainMeanPctChangeBaseline()
    baseline_predictions = simple_baseline.predict(X_test)
    mae_pct_change = mean_absolute_error(y_test, baseline_predictions)
    logger.info(f"Mean Absolute Error: {mae_pct_change}")


def temporal_train_test_split(
    ohlc_data: pd.DataFrame, last_n_days_to_test_model: int
) -> tuple[pd.DataFrame, pd.DataFrame]:
    """Split the data into train and test splits.

    Split is a temporal split. Last_n_days_to_test_model define
    the number of days for testing the model.

    Args:
    ----
    ohlc_data: The OHLC data to split.
    last_n_days_to_test_model: The number of days to test the model on.

    """
    max_data_in_dataset = ohlc_data["end_time"].max()
    cutoff_date = max_data_in_dataset - pd.Timedelta(
        days=last_n_days_to_test_model
    )
    train_df = ohlc_data[ohlc_data["end_time"] < cutoff_date]
    test_df = ohlc_data[ohlc_data["end_time"] >= cutoff_date]
    return train_df, test_df


def create_target_variable(
    ohlc_data: pd.DataFrame,
    prediction_window_tick: int,
) -> pd.DataFrame:
    """Create the target variable based on future close percentage changes.

    The target variable is generated by comparing the percentage change in the
    close price of the current tick with the close price of a future tick,
    defined by `prediction_window_tick`.

    Args:
    ----
    ohlc_data: The OHLC data to create the target variable for.
    prediction_window_tick: The number of ticks in the future to compare

    """
    ohlc_data["pct_change"] = (
        ohlc_data.groupby("product_id")["close"].pct_change(
            periods=prediction_window_tick
        )
        * 100
    )
    ohlc_data["target"] = ohlc_data.groupby("product_id")["pct_change"].shift(
        -prediction_window_tick
    )
    return ohlc_data.dropna(subset=["target"])


if __name__ == "__main__":
    main(
        feature_view_name="ohlc_feature_view",
        feature_view_version=1,
        product_id=SupportedCoins.BTC_USD.value,
        last_n_days_to_fetch_from_store=30,
        last_n_days_to_test_model=2,
        prediction_window_tick=1,
    )
